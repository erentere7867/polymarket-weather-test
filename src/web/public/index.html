<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Arbitrage Bot | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a;
            /* Slate 900 */
            color: #e2e8f0;
            /* Slate 200 */
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .state-idle {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            color: #60a5fa;
        }

        .state-fetch-mode {
            background: rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.5);
            color: #fbbf24;
            animation: pulse-amber 2s infinite;
        }

        @keyframes pulse-amber {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
        }

        .webhook-active {
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
        }

        .provider-healthy {
            color: #10b981;
        }

        .provider-error {
            color: #ef4444;
        }

        .provider-rate-limited {
            color: #f59e0b;
        }

        .timeline-item {
            position: relative;
            padding-left: 24px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 6px;
            top: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .timeline-item::after {
            content: '';
            position: absolute;
            left: 9px;
            top: 20px;
            width: 2px;
            height: calc(100% - 12px);
            background: rgba(255, 255, 255, 0.1);
        }

        .timeline-item:last-child::after {
            display: none;
        }

        /* Mode-specific styles */
        .mode-open-meteo {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            color: #60a5fa;
        }

        .mode-meteosource {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.5);
            color: #a78bfa;
            animation: pulse-purple 2s infinite;
        }

        @keyframes pulse-purple {
            0%, 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(139, 92, 246, 0); }
        }

        .mode-websocket {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.5);
            color: #34d399;
        }

        .mode-burst {
            background: rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.5);
            color: #fbbf24;
            animation: pulse-amber 1s infinite;
        }

        /* Urgency level indicators */
        .urgency-high {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
            color: #f87171;
            animation: pulse-red 2s infinite;
        }

        .urgency-medium {
            background: rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.5);
            color: #fbbf24;
        }

        .urgency-low {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.5);
            color: #34d399;
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        /* Progress bar styles */
        .progress-bar {
            transition: width 0.3s ease;
        }

        /* Button hover effects */
        .btn-mode {
            transition: all 0.2s ease;
        }
        .btn-mode:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .btn-mode:active {
            transform: translateY(0);
        }
    </style>
</head>

<body class="p-6">
    <div class="max-w-7xl mx-auto space-y-6">
        <!-- Header -->
        <header class="flex justify-between items-center glass p-6 rounded-xl">
            <div>
                <h1
                    class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
                    Polymarket Speed Bot
                </h1>
                <p class="text-slate-400 text-sm">v3.0.0 ‚Ä¢ Hybrid Weather Controller</p>
            </div>
            <div class="flex items-center space-x-6">
                <!-- Mode Indicator -->
                <div class="text-right">
                    <p class="text-xs text-slate-500 uppercase tracking-wider">Mode</p>
                    <p id="mode-text" class="text-blue-400 font-mono font-bold">LOADING...</p>
                </div>
                <!-- Auto Mode Indicator -->
                <div class="text-right">
                    <p class="text-xs text-slate-500 uppercase tracking-wider">Control</p>
                    <p id="auto-mode-text" class="text-emerald-400 font-mono font-bold">AUTO</p>
                </div>
                <!-- Urgency Level -->
                <div class="text-right">
                    <p class="text-xs text-slate-500 uppercase tracking-wider">Urgency</p>
                    <p id="urgency-text" class="text-emerald-400 font-mono font-bold">LOW</p>
                </div>
                <!-- Overall Status -->
                <div class="text-right">
                    <p class="text-xs text-slate-500 uppercase tracking-wider">Status</p>
                    <p id="status-text" class="text-emerald-400 font-mono font-bold">ONLINE</p>
                </div>
                <div class="h-3 w-3 rounded-full bg-emerald-500 animate-pulse"></div>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <!-- PnL Card -->
            <div class="glass p-6 rounded-xl">
                <p class="text-slate-500 text-xs uppercase tracking-wider">Total Equity</p>
                <h2 id="total-equity" class="text-2xl font-bold mt-1">$0.00</h2>
                <p id="total-pnl" class="text-sm mt-2 text-emerald-400">+$0.00 (0.00%)</p>
            </div>

            <!-- Cash Card -->
            <div class="glass p-6 rounded-xl">
                <p class="text-slate-500 text-xs uppercase tracking-wider">Available Cash</p>
                <h2 id="cash-balance" class="text-2xl font-bold mt-1">$0.00</h2>
            </div>

            <!-- Webhook Stats Card -->
            <div class="glass p-6 rounded-xl">
                <p class="text-slate-500 text-xs uppercase tracking-wider">Webhooks / Cycles</p>
                <h2 id="webhook-count" class="text-2xl font-bold mt-1">0</h2>
                <p id="fetch-cycles" class="text-sm mt-2 text-blue-400">0 fetch cycles</p>
            </div>

            <!-- Open Pos Card -->
            <div class="glass p-6 rounded-xl">
                <p class="text-slate-500 text-xs uppercase tracking-wider">Open Positions</p>
                <h2 id="open-positions-count" class="text-2xl font-bold mt-1">0</h2>
            </div>
        </div>

        <!-- Hybrid Weather Controller Status Panel -->
        <div class="glass p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Weather Controller Status
            </h3>
            
            <!-- Current Mode Display -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Current Mode -->
                <div id="current-mode-card" class="bg-slate-800/50 rounded-lg p-4 border border-white/5 mode-meteosource">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-slate-300">Current Mode</span>
                        <div class="flex items-center space-x-2">
                            <span id="auto-mode-badge" class="px-2 py-0.5 text-xs rounded-full bg-emerald-500/20 text-emerald-400">AUTO</span>
                            <span id="mode-badge" class="px-2 py-0.5 text-xs rounded-full bg-violet-500/20 text-violet-400">Active</span>
                        </div>
                    </div>
                    <p id="current-mode-name" class="text-lg font-bold">METEOSOURCE_POLLING</p>
                    <p id="mode-duration" class="text-xs text-slate-500 mt-1">Duration: 0s</p>
                </div>

                <!-- Urgency Level -->
                <div id="urgency-card" class="bg-slate-800/50 rounded-lg p-4 border border-white/5 urgency-low">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-slate-300">Urgency Level</span>
                        <span id="urgency-badge" class="px-2 py-0.5 text-xs rounded-full bg-emerald-500/20 text-emerald-400">LOW</span>
                    </div>
                    <p id="urgency-level" class="text-lg font-bold">LOW</p>
                    <p id="next-window" class="text-xs text-slate-500 mt-1">Next window: --</p>
                </div>

                <!-- Burst Progress -->
                <div id="burst-card" class="bg-slate-800/50 rounded-lg p-4 border border-white/5 opacity-50">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-slate-300">Burst Progress</span>
                        <span id="burst-badge" class="px-2 py-0.5 text-xs rounded-full bg-slate-600 text-slate-400">Inactive</span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-2 mt-2">
                        <div id="burst-progress-bar" class="bg-amber-500 h-2 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                    <p id="burst-progress-text" class="text-xs text-slate-500 mt-1">0/60 requests</p>
                </div>
            </div>

            <!-- Mode Control Buttons -->
            <div class="flex flex-wrap gap-3 mb-6">
                <button onclick="toggleMode()" class="btn-mode bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                    </svg>
                    <span>Toggle Mode</span>
                </button>
                <button onclick="forceOpenMeteo()" class="btn-mode bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>Open-Meteo</span>
                </button>
                <button onclick="forceMeteosource()" class="btn-mode bg-violet-700 hover:bg-violet-600 text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
                    </svg>
                    <span>Meteosource</span>
                </button>
                <button onclick="forceWebsocket()" class="btn-mode bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <span>WebSocket</span>
                </button>
                <button onclick="triggerBurst()" class="btn-mode bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <span>Trigger Burst</span>
                </button>
                <button onclick="returnToNormal()" class="btn-mode bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>Auto Mode</span>
                </button>
            </div>

            <!-- Urgency Window Schedule -->
            <div class="bg-slate-800/50 rounded-lg p-4 border border-white/5">
                <h4 class="text-sm font-medium text-slate-300 mb-3">UTC Urgency Windows</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="bg-slate-900/50 rounded p-3 border border-red-500/30">
                        <div class="text-xs text-red-400 font-bold mb-1">HIGH</div>
                        <div class="text-xs text-slate-400">00:30 - 02:30 UTC</div>
                        <div class="text-xs text-slate-500">Open-Meteo: 1s</div>
                    </div>
                    <div class="bg-slate-900/50 rounded p-3 border border-red-500/30">
                        <div class="text-xs text-red-400 font-bold mb-1">HIGH</div>
                        <div class="text-xs text-slate-400">12:30 - 14:30 UTC</div>
                        <div class="text-xs text-slate-500">Open-Meteo: 1s</div>
                    </div>
                    <div class="bg-slate-900/50 rounded p-3 border border-amber-500/30">
                        <div class="text-xs text-amber-400 font-bold mb-1">MEDIUM</div>
                        <div class="text-xs text-slate-400">06:30 - 07:30 UTC</div>
                        <div class="text-xs text-slate-500">Meteosource: 1s</div>
                    </div>
                    <div class="bg-slate-900/50 rounded p-3 border border-amber-500/30">
                        <div class="text-xs text-amber-400 font-bold mb-1">MEDIUM</div>
                        <div class="text-xs text-slate-400">18:30 - 19:30 UTC</div>
                        <div class="text-xs text-slate-500">Meteosource: 1s</div>
                    </div>
                </div>
                <div class="mt-3 p-2 bg-emerald-500/10 border border-emerald-500/30 rounded">
                    <div class="text-xs text-emerald-400 font-bold mb-1">LOW (Outside Windows)</div>
                    <div class="text-xs text-slate-400">Meteosource polling: 1s (continuous)</div>
                </div>
            </div>
        </div>

        <!-- Open-Meteo Quota Status -->
        <div class="glass p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                Open-Meteo Quota Status
            </h3>
            <div class="bg-slate-800/50 rounded-lg p-4 border border-white/5">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-300">Daily Quota Usage</span>
                    <span id="quota-percentage" class="text-sm font-bold text-emerald-400">0%</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-3">
                    <div id="quota-progress-bar" class="bg-gradient-to-r from-emerald-500 to-emerald-400 h-3 rounded-full progress-bar" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-2 text-xs text-slate-500">
                    <span id="quota-used">0 calls</span>
                    <span id="quota-limit">Limit: 9,500</span>
                </div>
                <div id="quota-warning" class="hidden mt-3 p-2 bg-amber-500/20 border border-amber-500/50 rounded text-xs text-amber-400">
                    ‚ö†Ô∏è Warning: Approaching quota limit
                </div>
                <div id="quota-exceeded" class="hidden mt-3 p-2 bg-red-500/20 border border-red-500/50 rounded text-xs text-red-400">
                    üö´ HARD QUOTA EXCEEDED: Open-Meteo disabled
                </div>
            </div>
        </div>

        <!-- Architecture Overview -->
        <div class="glass p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Urgency-Based Polling Architecture
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Open-Meteo Polling Mode -->
                <div class="bg-slate-800/50 rounded-lg p-4 border border-white/5">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-slate-300">Open-Meteo Polling</span>
                        <span id="openmeteo-badge" class="px-2 py-0.5 text-xs rounded-full bg-blue-500/20 text-blue-400">1s Polling</span>
                    </div>
                    <p class="text-xs text-slate-500 mb-2">1 req/sec ‚Ä¢ Batch requests ‚Ä¢ HIGH urgency only</p>
                    <div class="text-xs text-slate-400">
                        <span class="text-slate-500">Active during:</span>
                        <span>HIGH urgency windows</span>
                    </div>
                </div>

                <!-- FETCH_MODE -->
                <div class="bg-slate-800/50 rounded-lg p-4 border border-white/5">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-slate-300">Burst Mode</span>
                        <span id="fetch-mode-badge" class="px-2 py-0.5 text-xs rounded-full bg-slate-600 text-slate-400">Inactive</span>
                    </div>
                    <p class="text-xs text-slate-500 mb-2">1 req/sec for 60s ‚Ä¢ Open-Meteo ‚Üí Tomorrow ‚Üí OpenWeather</p>
                    <div class="text-xs text-slate-400">
                        <span class="text-slate-500">Trigger:</span>
                        <span>WebSocket forecast changes only</span>
                    </div>
                </div>

                <!-- Meteosource Polling Mode -->
                <div class="bg-slate-800/50 rounded-lg p-4 border border-white/5">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-slate-300">Meteosource Polling</span>
                        <span id="meteosource-badge" class="px-2 py-0.5 text-xs rounded-full bg-violet-500/20 text-violet-400">1s Polling</span>
                    </div>
                    <p class="text-xs text-slate-500 mb-2">1 req/sec ‚Ä¢ Batch requests ‚Ä¢ LOW/MEDIUM urgency</p>
                    <div class="text-xs text-slate-400">
                        <span class="text-slate-500">Active during:</span>
                        <span>LOW and MEDIUM urgency</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- City States -->
        <div class="glass p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
                City State Monitor
            </h3>
            <div id="city-states-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                <div class="text-slate-500 text-sm italic">No cities monitored yet...</div>
            </div>
        </div>

        <!-- Provider Health -->
        <div class="glass p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Provider Health
            </h3>
            <div id="provider-health-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
                <div class="text-slate-500 text-sm italic">Loading providers...</div>
            </div>
        </div>

        <!-- Settings Card -->
        <div class="glass p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4">Strategy Settings</h3>
            <div class="flex flex-wrap gap-6 items-end">
                <div>
                    <label class="block text-slate-400 text-xs uppercase tracking-wider mb-2">Take Profit (%)</label>
                    <input type="number" id="tp-input" value="5" step="0.5"
                        class="bg-slate-800/50 border border-white/10 rounded px-4 py-2 text-emerald-400 w-32 focus:outline-none focus:border-emerald-500 transition-colors">
                </div>
                <div>
                    <label class="block text-slate-400 text-xs uppercase tracking-wider mb-2">Stop Loss (%)</label>
                    <input type="number" id="sl-input" value="-10" step="0.5"
                        class="bg-slate-800/50 border border-white/10 rounded px-4 py-2 text-rose-400 w-32 focus:outline-none focus:border-rose-500 transition-colors">
                </div>
                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="skip-price-check" class="w-5 h-5 rounded border-white/10 bg-slate-800/50 text-blue-500 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer">
                    <label for="skip-price-check" class="text-slate-400 text-sm cursor-pointer select-none">
                        <span class="block text-xs uppercase tracking-wider text-slate-500">Fast Execution</span>
                        Skip price checks on forecast changes
                    </label>
                </div>
                <button onclick="saveSettings()"
                    class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded font-medium transition-colors flex items-center space-x-2">
                    <span>Save Configuration</span>
                </button>
                <div id="save-msg" class="text-sm opacity-0 transition-opacity"></div>
            </div>
        </div>

        <!-- Active Positions Table -->
        <div class="glass rounded-xl overflow-hidden">
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-xl font-bold">Active Trades</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-slate-400">
                    <thead class="bg-slate-800/50 text-xs uppercase">
                        <tr>
                            <th class="p-4">Market</th>
                            <th class="p-4">Pos</th>
                            <th class="p-4">Entry</th>
                            <th class="p-4">Current</th>
                            <th class="p-4">Size</th>
                            <th class="p-4">PnL</th>
                        </tr>
                    </thead>
                    <tbody id="positions-table" class="divide-y divide-white/5">
                        <!-- Rows injected by JS -->
                        <tr>
                            <td colspan="6" class="p-8 text-center text-slate-600 italic">No active positions... yet.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Closed Trades Table -->
        <div class="glass rounded-xl overflow-hidden">
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-xl font-bold">Closed Trades</h3>
                <div class="flex space-x-4 text-sm">
                    <span id="win-rate" class="text-emerald-400">Win Rate: 0%</span>
                    <span id="total-realized-pnl" class="text-slate-400">Realized: $0.00</span>
                </div>
            </div>
            <div class="overflow-x-auto max-h-96">
                <table class="w-full text-left text-slate-400">
                    <thead class="bg-slate-800/50 text-xs uppercase sticky top-0">
                        <tr>
                            <th class="p-4">Market</th>
                            <th class="p-4">Side</th>
                            <th class="p-4">Entry</th>
                            <th class="p-4">Exit</th>
                            <th class="p-4">Shares</th>
                            <th class="p-4">PnL ($)</th>
                            <th class="p-4">PnL (%)</th>
                            <th class="p-4">Duration</th>
                        </tr>
                    </thead>
                    <tbody id="closed-positions-table" class="divide-y divide-white/5">
                        <tr>
                            <td colspan="8" class="p-8 text-center text-slate-600 italic">No closed trades yet.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        const API_BASE = '/api';

        async function fetchStats() {
            try {
                // 1. Status
                const statusRes = await fetch(`${API_BASE}/status`);
                const statusData = await statusRes.json();

                // 2. Portfolio
                const portRes = await fetch(`${API_BASE}/portfolio`);
                const portData = await portRes.json();

                document.getElementById('total-equity').innerText = formatCurrency(portData.totalValue);
                document.getElementById('cash-balance').innerText = formatCurrency(portData.currentCash);

                const pnl = portData.unrealizedPnL + portData.realizedPnL;
                const pnlEl = document.getElementById('total-pnl');
                pnlEl.innerText = `${pnl >= 0 ? '+' : ''}${formatCurrency(pnl)}`;
                pnlEl.className = `text-sm mt-2 ${pnl >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;

                // 3. Positions
                const posRes = await fetch(`${API_BASE}/positions/active`);
                const positions = await posRes.json();

                document.getElementById('open-positions-count').innerText = positions.length;
                renderPositions(positions);

                // 4. Closed Positions
                const closedRes = await fetch(`${API_BASE}/positions/closed`);
                const closedPositions = await closedRes.json();
                renderClosedPositions(closedPositions);

                // Update win rate and realized PnL stats
                if (closedPositions.length > 0) {
                    const wins = closedPositions.filter(p => p.realizedPnL > 0).length;
                    const winRate = ((wins / closedPositions.length) * 100).toFixed(1);
                    const totalRealizedPnL = closedPositions.reduce((sum, p) => sum + p.realizedPnL, 0);

                    document.getElementById('win-rate').innerText = `Win Rate: ${winRate}%`;
                    const realizedEl = document.getElementById('total-realized-pnl');
                    realizedEl.innerText = `Realized: ${totalRealizedPnL >= 0 ? '+' : ''}${formatCurrency(totalRealizedPnL)}`;
                    realizedEl.className = `text-sm ${totalRealizedPnL >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
                }

            } catch (err) {
                console.error('Fetch error:', err);
                document.getElementById('status-text').innerText = 'OFFLINE';
                document.getElementById('status-text').className = 'text-rose-500 font-bold font-mono';
            }
        }

        async function fetchHybridWeatherStatus() {
            try {
                const res = await fetch(`${API_BASE}/hybrid-weather/status`);
                const data = await res.json();

                // Update mode display
                const modeText = document.getElementById('mode-text');
                const modeName = document.getElementById('current-mode-name');
                const modeCard = document.getElementById('current-mode-card');
                const modeBadge = document.getElementById('mode-badge');
                const autoModeText = document.getElementById('auto-mode-text');
                const autoModeBadge = document.getElementById('auto-mode-badge');
                
                modeText.innerText = data.currentMode;
                modeName.innerText = data.currentMode;
                
                // Update auto mode indicator
                if (data.isAutoMode) {
                    autoModeText.innerText = 'AUTO';
                    autoModeText.className = 'text-emerald-400 font-mono font-bold';
                    autoModeBadge.className = 'px-2 py-0.5 text-xs rounded-full bg-emerald-500/20 text-emerald-400';
                    autoModeBadge.innerText = 'AUTO';
                } else {
                    autoModeText.innerText = 'MANUAL';
                    autoModeText.className = 'text-amber-400 font-mono font-bold';
                    autoModeBadge.className = 'px-2 py-0.5 text-xs rounded-full bg-amber-500/20 text-amber-400';
                    autoModeBadge.innerText = 'MANUAL';
                }
                
                // Update mode card styling
                modeCard.className = 'bg-slate-800/50 rounded-lg p-4 border border-white/5';
                if (data.currentMode === 'OPEN_METEO_POLLING') {
                    modeCard.classList.add('mode-open-meteo');
                    modeBadge.className = 'px-2 py-0.5 text-xs rounded-full bg-blue-500/20 text-blue-400';
                    modeBadge.innerText = 'Polling';
                } else if (data.currentMode === 'METEOSOURCE_POLLING') {
                    modeCard.classList.add('mode-meteosource');
                    modeBadge.className = 'px-2 py-0.5 text-xs rounded-full bg-violet-500/20 text-violet-400';
                    modeBadge.innerText = 'Meteosource';
                } else if (data.currentMode === 'WEBSOCKET_REST') {
                    modeCard.classList.add('mode-websocket');
                    modeBadge.className = 'px-2 py-0.5 text-xs rounded-full bg-emerald-500/20 text-emerald-400';
                    modeBadge.innerText = 'Rest Mode';
                } else if (data.currentMode === 'ROUND_ROBIN_BURST') {
                    modeCard.classList.add('mode-burst');
                    modeBadge.className = 'px-2 py-0.5 text-xs rounded-full bg-amber-500/20 text-amber-400';
                    modeBadge.innerText = 'Burst';
                }

                // Update mode duration
                const durationSec = Math.floor(data.modeDuration / 1000);
                const durationMin = Math.floor(durationSec / 60);
                const durationStr = durationMin > 0 ? `${durationMin}m ${durationSec % 60}s` : `${durationSec}s`;
                document.getElementById('mode-duration').innerText = `Duration: ${durationStr}`;

                // Update urgency display
                const urgencyText = document.getElementById('urgency-text');
                const urgencyLevel = document.getElementById('urgency-level');
                const urgencyCard = document.getElementById('urgency-card');
                const urgencyBadge = document.getElementById('urgency-badge');
                
                urgencyText.innerText = data.currentUrgency;
                urgencyLevel.innerText = data.currentUrgency;
                
                urgencyCard.className = 'bg-slate-800/50 rounded-lg p-4 border border-white/5';
                if (data.currentUrgency === 'HIGH') {
                    urgencyCard.classList.add('urgency-high');
                    urgencyBadge.className = 'px-2 py-0.5 text-xs rounded-full bg-red-500/20 text-red-400';
                    urgencyBadge.innerText = 'HIGH';
                } else if (data.currentUrgency === 'MEDIUM') {
                    urgencyCard.classList.add('urgency-medium');
                    urgencyBadge.className = 'px-2 py-0.5 text-xs rounded-full bg-amber-500/20 text-amber-400';
                    urgencyBadge.innerText = 'MEDIUM';
                } else {
                    urgencyCard.classList.add('urgency-low');
                    urgencyBadge.className = 'px-2 py-0.5 text-xs rounded-full bg-emerald-500/20 text-emerald-400';
                    urgencyBadge.innerText = 'LOW';
                }

                // Update next window
                if (data.nextUrgencyWindow) {
                    document.getElementById('next-window').innerText = `Next: ${data.nextUrgencyWindow.level} in ${data.nextUrgencyWindow.timeUntil}`;
                }

                // Update burst progress
                const burstCard = document.getElementById('burst-card');
                const burstBadge = document.getElementById('burst-badge');
                const burstProgressBar = document.getElementById('burst-progress-bar');
                const burstProgressText = document.getElementById('burst-progress-text');
                
                if (data.burstProgress) {
                    burstCard.classList.remove('opacity-50');
                    burstBadge.className = 'px-2 py-0.5 text-xs rounded-full bg-amber-500/20 text-amber-400';
                    burstBadge.innerText = 'Active';
                    
                    const progress = (data.burstProgress.requestsCompleted / data.burstProgress.totalRequests) * 100;
                    burstProgressBar.style.width = `${progress}%`;
                    burstProgressText.innerText = `${data.burstProgress.requestsCompleted}/${data.burstProgress.totalRequests} requests`;
                } else {
                    burstCard.classList.add('opacity-50');
                    burstBadge.className = 'px-2 py-0.5 text-xs rounded-full bg-slate-600 text-slate-400';
                    burstBadge.innerText = 'Inactive';
                    burstProgressBar.style.width = '0%';
                    burstProgressText.innerText = '0/60 requests';
                }

            } catch (err) {
                console.error('Hybrid weather status error:', err);
            }
        }

        async function fetchApiCallsStatus() {
            try {
                const res = await fetch(`${API_BASE}/api-calls/status`);
                const data = await res.json();

                // Find Open-Meteo provider
                const openMeteo = data.providers.find(p => p.provider === 'openmeteo');
                if (openMeteo && openMeteo.hardQuotaLimit) {
                    const percentage = Math.min(100, (openMeteo.callCount / openMeteo.hardQuotaLimit) * 100);
                    
                    document.getElementById('quota-percentage').innerText = `${percentage.toFixed(1)}%`;
                    document.getElementById('quota-progress-bar').style.width = `${percentage}%`;
                    document.getElementById('quota-used').innerText = `${openMeteo.callCount.toLocaleString()} calls`;
                    
                    // Change color based on usage
                    const progressBar = document.getElementById('quota-progress-bar');
                    if (percentage >= 100) {
                        progressBar.className = 'bg-red-500 h-3 rounded-full progress-bar';
                        document.getElementById('quota-percentage').className = 'text-sm font-bold text-red-400';
                        document.getElementById('quota-exceeded').classList.remove('hidden');
                        document.getElementById('quota-warning').classList.add('hidden');
                    } else if (percentage >= 80) {
                        progressBar.className = 'bg-amber-500 h-3 rounded-full progress-bar';
                        document.getElementById('quota-percentage').className = 'text-sm font-bold text-amber-400';
                        document.getElementById('quota-warning').classList.remove('hidden');
                        document.getElementById('quota-exceeded').classList.add('hidden');
                    } else {
                        progressBar.className = 'bg-gradient-to-r from-emerald-500 to-emerald-400 h-3 rounded-full progress-bar';
                        document.getElementById('quota-percentage').className = 'text-sm font-bold text-emerald-400';
                        document.getElementById('quota-warning').classList.add('hidden');
                        document.getElementById('quota-exceeded').classList.add('hidden');
                    }
                }

            } catch (err) {
                console.error('API calls status error:', err);
            }
        }

        async function fetchWebhookStats() {
            try {
                // Webhook Status
                const webhookRes = await fetch(`${API_BASE}/webhook/status`);
                const webhookData = await webhookRes.json();

                document.getElementById('webhook-count').innerText = webhookData.webhooksReceived || 0;
                
                // Update webhook badge
                const webhookBadge = document.getElementById('webhook-badge');
                if (webhookData.webhookSecretConfigured) {
                    webhookBadge.innerText = 'Configured';
                    webhookBadge.className = 'px-2 py-0.5 text-xs rounded-full bg-emerald-500/20 text-emerald-400';
                } else {
                    webhookBadge.innerText = 'No Secret';
                    webhookBadge.className = 'px-2 py-0.5 text-xs rounded-full bg-amber-500/20 text-amber-400';
                }

                // Update last webhook time
                const lastWebhookEl = document.getElementById('last-webhook-time');
                if (webhookData.lastWebhookTime) {
                    const date = new Date(webhookData.lastWebhookTime);
                    lastWebhookEl.innerText = formatTimeAgo(date);
                } else {
                    lastWebhookEl.innerText = 'Never';
                }

            } catch (err) {
                console.error('Webhook stats error:', err);
            }
        }

        async function fetchStateMachineStats() {
            try {
                const res = await fetch(`${API_BASE}/state-machine/stats`);
                const data = await res.json();

                // Update FETCH_MODE badge
                const fetchModeBadge = document.getElementById('fetch-mode-badge');
                const fetchModeCount = data.citiesInFetchMode?.length || 0;
                fetchModeBadge.innerText = fetchModeCount > 0 ? `${fetchModeCount} active` : 'Inactive';
                
                if (fetchModeCount > 0) {
                    fetchModeBadge.className = 'px-2 py-0.5 text-xs rounded-full bg-amber-500/20 text-amber-400';
                } else {
                    fetchModeBadge.className = 'px-2 py-0.5 text-xs rounded-full bg-slate-600 text-slate-400';
                }

                // Render city states
                renderCityStates(data.cities || []);

            } catch (err) {
                console.error('State machine stats error:', err);
            }
        }

        async function fetchProviderHealth() {
            try {
                const res = await fetch(`${API_BASE}/providers/health`);
                const data = await res.json();

                renderProviderHealth(data.providers || []);

            } catch (err) {
                console.error('Provider health error:', err);
            }
        }

        async function fetchForecastTriggers() {
            try {
                const res = await fetch(`${API_BASE}/forecast/triggers`);
                const data = await res.json();

                document.getElementById('fetch-cycles').innerText = `${data.fetchCyclesCompleted || 0} fetch cycles`;

            } catch (err) {
                console.error('Forecast triggers error:', err);
            }
        }

        // Mode control functions
        async function toggleMode() {
            try {
                const res = await fetch(`${API_BASE}/hybrid-weather/toggle`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    showNotification(`${data.currentMode} (Manual mode - auto disabled)`, 'success');
                    fetchHybridWeatherStatus();
                }
            } catch (err) {
                showNotification('Failed to toggle mode', 'error');
            }
        }

        async function forceOpenMeteo() {
            try {
                const res = await fetch(`${API_BASE}/hybrid-weather/force-mode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'OPEN_METEO_POLLING', reason: 'manual_override' })
                });
                const data = await res.json();
                if (data.success) {
                    showNotification('MANUAL: Open-Meteo polling (auto disabled)', 'success');
                    fetchHybridWeatherStatus();
                }
            } catch (err) {
                showNotification('Failed to switch mode', 'error');
            }
        }

        async function forceMeteosource() {
            try {
                const res = await fetch(`${API_BASE}/hybrid-weather/force-mode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'METEOSOURCE_POLLING', reason: 'manual_override' })
                });
                const data = await res.json();
                if (data.success) {
                    showNotification('MANUAL: Meteosource polling mode (2s interval, auto disabled)', 'success');
                    fetchHybridWeatherStatus();
                }
            } catch (err) {
                showNotification('Failed to switch mode', 'error');
            }
        }

        async function forceWebsocket() {
            try {
                const res = await fetch(`${API_BASE}/hybrid-weather/force-mode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'WEBSOCKET_REST', reason: 'manual_override' })
                });
                const data = await res.json();
                if (data.success) {
                    showNotification('MANUAL: WebSocket rest mode (auto disabled)', 'success');
                    fetchHybridWeatherStatus();
                }
            } catch (err) {
                showNotification('Failed to switch mode', 'error');
            }
        }

        async function triggerBurst() {
            const cityId = prompt('Enter city ID for burst mode (or leave empty for all cities):');
            try {
                const res = await fetch(`${API_BASE}/hybrid-weather/burst`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cityId: cityId || 'all' })
                });
                const data = await res.json();
                if (data.success) {
                    showNotification('Burst mode triggered', 'success');
                    fetchHybridWeatherStatus();
                }
            } catch (err) {
                showNotification('Failed to trigger burst', 'error');
            }
        }

        async function returnToNormal() {
            try {
                const res = await fetch(`${API_BASE}/hybrid-weather/normal`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    showNotification(`AUTO mode enabled - ${data.currentMode} (${data.currentUrgency} urgency)`, 'success');
                    fetchHybridWeatherStatus();
                }
            } catch (err) {
                showNotification('Failed to return to normal', 'error');
            }
        }

        function showNotification(message, type) {
            // Create notification element
            const notif = document.createElement('div');
            notif.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 transition-opacity duration-300 ${
                type === 'success' ? 'bg-emerald-600' : 'bg-red-600'
            }`;
            notif.innerText = message;
            document.body.appendChild(notif);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function renderCityStates(cities) {
            const container = document.getElementById('city-states-container');
            
            if (cities.length === 0) {
                container.innerHTML = '<div class="text-slate-500 text-sm italic">No cities monitored yet...</div>';
                return;
            }

            container.innerHTML = cities.map(city => {
                const isFetchMode = city.state === 'FETCH_MODE';
                const stateClass = isFetchMode ? 'state-fetch-mode' : 'state-idle';
                const stateLabel = isFetchMode ? 'FETCH' : 'IDLE';
                const entryTime = city.fetchModeEntryTime 
                    ? formatTimeAgo(new Date(city.fetchModeEntryTime))
                    : '-';
                
                // Calculate error indicators
                const errorCount = Object.values(city.providerErrorCounts || {}).reduce((a, b) => a + b, 0);
                const errorIndicator = errorCount > 0 
                    ? `<span class="text-rose-400 text-xs">${errorCount} errors</span>` 
                    : '';

                return `
                    <div class="${stateClass} rounded-lg p-3 border transition-all">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-sm truncate" title="${city.cityId}">${formatCityName(city.cityId)}</span>
                            <span class="text-xs font-bold">${stateLabel}</span>
                        </div>
                        <div class="text-xs opacity-75">
                            ${isFetchMode ? `Since: ${entryTime}` : 'Waiting for webhook...'}
                        </div>
                        ${errorIndicator}
                    </div>
                `;
            }).join('');
        }

        function renderProviderHealth(providers) {
            const container = document.getElementById('provider-health-container');
            
            if (providers.length === 0) {
                container.innerHTML = '<div class="text-slate-500 text-sm italic">No providers configured</div>';
                return;
            }

            container.innerHTML = providers.map(provider => {
                let statusClass = 'provider-healthy';
                let statusText = 'OK';
                let statusIcon = '‚úì';

                if (!provider.isConfigured) {
                    statusClass = 'text-slate-500';
                    statusText = 'Not Config';
                    statusIcon = '‚àí';
                } else if (provider.isRateLimited) {
                    statusClass = 'provider-rate-limited';
                    statusText = 'Rate Limited';
                    statusIcon = '!';
                }

                return `
                    <div class="bg-slate-800/50 rounded-lg p-3 border border-white/5 ${provider.isRateLimited ? 'border-amber-500/30' : ''}">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-sm capitalize">${provider.name}</span>
                            <span class="${statusClass} text-xs font-bold">${statusIcon}</span>
                        </div>
                        <div class="text-xs ${statusClass}">${statusText}</div>
                        ${provider.isRateLimited && provider.rateLimitResetTime > 0 ? `
                            <div class="text-xs text-amber-400 mt-1">Reset in ${Math.ceil(provider.rateLimitResetTime / 1000)}s</div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function formatCityName(cityId) {
            return cityId
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase())
                .substring(0, 20);
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);

            if (diffSecs < 60) return `${diffSecs}s ago`;
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return date.toLocaleDateString();
        }

        function renderPositions(positions) {
            const tbody = document.getElementById('positions-table');
            if (positions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-600 italic">No active positions... yet.</td></tr>`;
                return;
            }

            tbody.innerHTML = positions.map(p => `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="p-4 font-medium text-white truncate max-w-xs" title="${p.marketTitle}">${p.marketTitle}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${p.side === 'yes' ? 'bg-emerald-500/20 text-emerald-300' : 'bg-rose-500/20 text-rose-300'}">${p.side.toUpperCase()}</span></td>
                    <td class="p-4">${formatPrice(p.entryPrice)}</td>
                    <td class="p-4 text-white">${formatPrice(p.currentPrice)}</td>
                    <td class="p-4">${p.shares}</td>
                    <td class="p-4 font-mono font-bold ${p.pnlPercent >= 0 ? 'text-emerald-400' : 'text-rose-400'}">
                        ${p.pnlPercent >= 0 ? '+' : ''}${p.pnlPercent.toFixed(2)}%
                    </td>
                </tr>
            `).join('');
        }

        function renderClosedPositions(positions) {
            const tbody = document.getElementById('closed-positions-table');
            if (positions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="p-8 text-center text-slate-600 italic">No closed trades yet.</td></tr>`;
                return;
            }

            tbody.innerHTML = positions.map(p => `
                <tr class="hover:bg-white/5 transition-colors ${p.realizedPnL >= 0 ? 'border-l-2 border-emerald-500/50' : 'border-l-2 border-rose-500/50'}">
                    <td class="p-4 font-medium text-white truncate max-w-xs" title="${p.marketQuestion}">${p.marketQuestion.substring(0, 40)}...</td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${p.side === 'yes' ? 'bg-emerald-500/20 text-emerald-300' : 'bg-rose-500/20 text-rose-300'}">${p.side.toUpperCase()}</span></td>
                    <td class="p-4">${formatPrice(p.entryPrice)}</td>
                    <td class="p-4">${formatPrice(p.exitPrice)}</td>
                    <td class="p-4">${p.shares}</td>
                    <td class="p-4 font-mono font-bold ${p.realizedPnL >= 0 ? 'text-emerald-400' : 'text-rose-400'}">
                        ${p.realizedPnL >= 0 ? '+' : ''}${formatCurrency(p.realizedPnL)}
                    </td>
                    <td class="p-4 font-mono font-bold ${p.pnlPercent >= 0 ? 'text-emerald-400' : 'text-rose-400'}">
                        ${p.pnlPercent >= 0 ? '+' : ''}${p.pnlPercent.toFixed(2)}%
                    </td>
                    <td class="p-4 text-slate-500">${formatDuration(p.holdDurationSeconds)}</td>
                </tr>
            `).join('');
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
        }

        function formatPrice(num) {
            return '$' + num.toFixed(3);
        }

        function formatDuration(seconds) {
            const secs = Math.floor(seconds);
            if (secs < 60) return `${secs}s`;
            if (secs < 3600) return `${Math.floor(secs / 60)}m ${secs % 60}s`;
            const hrs = Math.floor(secs / 3600);
            const mins = Math.floor((secs % 3600) / 60);
            return `${hrs}h ${mins}m`;
        }

        function formatTime(seconds) {
            const secs = Math.floor(seconds);
            if (secs < 60) return secs + 's';
            const mins = Math.floor(secs / 60);
            const hrs = Math.floor(mins / 60);
            if (hrs > 0) return `${hrs}h ${mins % 60}m`;
            return `${mins}m ${secs % 60}s`;
        }

        // Poll every 3 seconds
        fetchStats();
        fetchHybridWeatherStatus();
        fetchApiCallsStatus();
        fetchWebhookStats();
        fetchStateMachineStats();
        fetchProviderHealth();
        fetchForecastTriggers();
        fetchSettings();

        setInterval(fetchStats, 3000);
        setInterval(fetchHybridWeatherStatus, 1000); // Update more frequently for burst progress
        setInterval(fetchApiCallsStatus, 5000);
        setInterval(fetchWebhookStats, 3000);
        setInterval(fetchStateMachineStats, 3000);
        setInterval(fetchProviderHealth, 10000);
        setInterval(fetchForecastTriggers, 3000);

        async function fetchSettings() {
            try {
                const res = await fetch(`${API_BASE}/settings`);
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('tp-input').value = data.takeProfit;
                    document.getElementById('sl-input').value = data.stopLoss;
                    document.getElementById('skip-price-check').checked = data.skipPriceCheck || false;
                }
            } catch (err) {
                console.error('Failed to fetch settings:', err);
            }
        }

        async function saveSettings() {
            const tpInput = document.getElementById('tp-input');
            const slInput = document.getElementById('sl-input');
            const skipPriceCheckInput = document.getElementById('skip-price-check');
            const msgEl = document.getElementById('save-msg');

            const takeProfit = parseFloat(tpInput.value);
            const stopLoss = parseFloat(slInput.value);
            const skipPriceCheck = skipPriceCheckInput.checked;

            try {
                const res = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ takeProfit, stopLoss, skipPriceCheck })
                });

                if (res.ok) {
                    msgEl.innerText = '‚úÖ Settings Saved!';
                    msgEl.className = 'text-sm text-emerald-400 opacity-100 transition-opacity';
                } else {
                    const data = await res.json();
                    msgEl.innerText = '‚ùå Error: ' + (data.error || 'Failed');
                    msgEl.className = 'text-sm text-rose-400 opacity-100 transition-opacity';
                }

                setTimeout(() => {
                    msgEl.className = 'text-sm opacity-0 transition-opacity';
                }, 3000);

            } catch (err) {
                console.error('Save error:', err);
                msgEl.innerText = '‚ùå Network Error';
                msgEl.className = 'text-sm text-rose-400 opacity-100 transition-opacity';
            }
        }
    </script>
</body>

</html>
