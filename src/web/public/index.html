<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Arbitrage Bot | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a;
            /* Slate 900 */
            color: #e2e8f0;
            /* Slate 200 */
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body class="p-6">
    <div class="max-w-7xl mx-auto space-y-6">
        <!-- Header -->
        <header class="flex justify-between items-center glass p-6 rounded-xl">
            <div>
                <h1
                    class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
                    Polymarket Speed Bot
                </h1>
                <p class="text-slate-400 text-sm">v2.0.0 • Speed Arbitrage Engine</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <p class="text-xs text-slate-500">STATUS</p>
                    <p id="status-text" class="text-emerald-400 font-mono font-bold">ONLINE</p>
                </div>
                <div class="h-3 w-3 rounded-full bg-emerald-500 animate-pulse"></div>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <!-- PnL Card -->
            <div class="glass p-6 rounded-xl">
                <p class="text-slate-500 text-xs uppercase tracking-wider">Total Equity</p>
                <h2 id="total-equity" class="text-2xl font-bold mt-1">$0.00</h2>
                <p id="total-pnl" class="text-sm mt-2 text-emerald-400">+$0.00 (0.00%)</p>
            </div>

            <!-- Cash Card -->
            <div class="glass p-6 rounded-xl">
                <p class="text-slate-500 text-xs uppercase tracking-wider">Available Cash</p>
                <h2 id="cash-balance" class="text-2xl font-bold mt-1">$0.00</h2>
            </div>

            <!-- Cycles Card -->
            <div class="glass p-6 rounded-xl">
                <p class="text-slate-500 text-xs uppercase tracking-wider">Uptime / Cycles</p>
                <h2 id="uptime" class="text-2xl font-bold mt-1">0s</h2>
                <p id="cycle-count" class="text-sm mt-2 text-blue-400">Cycle #0</p>
            </div>

            <!-- Open Pos Card -->
            <div class="glass p-6 rounded-xl">
                <p class="text-slate-500 text-xs uppercase tracking-wider">Open Positions</p>
                <h2 id="open-positions-count" class="text-2xl font-bold mt-1">0</h2>
            </div>
        </div>

        <!-- Settings Card -->
        <div class="glass p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4">Strategy Settings</h3>
            <div class="flex flex-wrap gap-6 items-end">
                <div>
                    <label class="block text-slate-400 text-xs uppercase tracking-wider mb-2">Take Profit (%)</label>
                    <input type="number" id="tp-input" value="5" step="0.5"
                        class="bg-slate-800/50 border border-white/10 rounded px-4 py-2 text-emerald-400 w-32 focus:outline-none focus:border-emerald-500 transition-colors">
                </div>
                <div>
                    <label class="block text-slate-400 text-xs uppercase tracking-wider mb-2">Stop Loss (%)</label>
                    <input type="number" id="sl-input" value="-10" step="0.5"
                        class="bg-slate-800/50 border border-white/10 rounded px-4 py-2 text-rose-400 w-32 focus:outline-none focus:border-rose-500 transition-colors">
                </div>
                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="skip-price-check" class="w-5 h-5 rounded border-white/10 bg-slate-800/50 text-blue-500 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer">
                    <label for="skip-price-check" class="text-slate-400 text-sm cursor-pointer select-none">
                        <span class="block text-xs uppercase tracking-wider text-slate-500">Fast Execution</span>
                        Skip price checks on forecast changes
                    </label>
                </div>
                <button onclick="saveSettings()"
                    class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded font-medium transition-colors flex items-center space-x-2">
                    <span>Save Configuration</span>
                </button>
                <div id="save-msg" class="text-sm opacity-0 transition-opacity"></div>
            </div>
        </div>

        <!-- Speed Settings Card -->
        <div class="glass p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4">Speed Settings</h3>
            <div class="flex flex-wrap gap-6 items-end">
                <div>
                    <label class="block text-slate-400 text-xs uppercase tracking-wider mb-2">Forecast Poll Interval (ms)</label>
                    <input type="number" id="poll-interval-input" value="5000" step="500" min="1000" max="60000"
                        class="bg-slate-800/50 border border-white/10 rounded px-4 py-2 text-blue-400 w-40 focus:outline-none focus:border-blue-500 transition-colors">
                    <p class="text-xs text-slate-500 mt-1">How often to check weather APIs</p>
                </div>
                <div>
                    <label class="block text-slate-400 text-xs uppercase tracking-wider mb-2">Cache TTL (ms)</label>
                    <input type="number" id="cache-ttl-input" value="2000" step="500" min="0" max="30000"
                        class="bg-slate-800/50 border border-white/10 rounded px-4 py-2 text-purple-400 w-40 focus:outline-none focus:border-purple-500 transition-colors">
                    <p class="text-xs text-slate-500 mt-1">How long to cache weather data</p>
                </div>
                <button onclick="saveSpeedSettings()"
                    class="bg-purple-600 hover:bg-purple-500 text-white px-6 py-2 rounded font-medium transition-colors flex items-center space-x-2">
                    <span>Save Speed Settings</span>
                </button>
                <div id="speed-save-msg" class="text-sm opacity-0 transition-opacity"></div>
            </div>
        </div>

        <!-- Active Positions Table -->
        <div class="glass rounded-xl overflow-hidden">
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-xl font-bold">Active Trades</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-slate-400">
                    <thead class="bg-slate-800/50 text-xs uppercase">
                        <tr>
                            <th class="p-4">Market</th>
                            <th class="p-4">Pos</th>
                            <th class="p-4">Entry</th>
                            <th class="p-4">Current</th>
                            <th class="p-4">Size</th>
                            <th class="p-4">PnL</th>
                        </tr>
                    </thead>
                    <tbody id="positions-table" class="divide-y divide-white/5">
                        <!-- Rows injected by JS -->
                        <tr>
                            <td colspan="6" class="p-8 text-center text-slate-600 italic">No active positions... yet.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Closed Trades Table -->
        <div class="glass rounded-xl overflow-hidden">
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-xl font-bold">Closed Trades</h3>
                <div class="flex space-x-4 text-sm">
                    <span id="win-rate" class="text-emerald-400">Win Rate: 0%</span>
                    <span id="total-realized-pnl" class="text-slate-400">Realized: $0.00</span>
                </div>
            </div>
            <div class="overflow-x-auto max-h-96">
                <table class="w-full text-left text-slate-400">
                    <thead class="bg-slate-800/50 text-xs uppercase sticky top-0">
                        <tr>
                            <th class="p-4">Market</th>
                            <th class="p-4">Side</th>
                            <th class="p-4">Entry</th>
                            <th class="p-4">Exit</th>
                            <th class="p-4">Shares</th>
                            <th class="p-4">PnL ($)</th>
                            <th class="p-4">PnL (%)</th>
                            <th class="p-4">Duration</th>
                        </tr>
                    </thead>
                    <tbody id="closed-positions-table" class="divide-y divide-white/5">
                        <tr>
                            <td colspan="8" class="p-8 text-center text-slate-600 italic">No closed trades yet.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        const API_BASE = '/api';

        async function fetchStats() {
            try {
                // 1. Status
                const statusRes = await fetch(`${API_BASE}/status`);
                const statusData = await statusRes.json();

                document.getElementById('cycle-count').innerText = `Cycle #${statusData.cycles}`;
                document.getElementById('uptime').innerText = formatTime(statusData.uptime);

                // 2. Portfolio
                const portRes = await fetch(`${API_BASE}/portfolio`);
                const portData = await portRes.json();

                document.getElementById('total-equity').innerText = formatCurrency(portData.totalValue);
                document.getElementById('cash-balance').innerText = formatCurrency(portData.currentCash);

                const pnl = portData.unrealizedPnL + portData.realizedPnL; // Simplified
                const pnlEl = document.getElementById('total-pnl');
                pnlEl.innerText = `${pnl >= 0 ? '+' : ''}${formatCurrency(pnl)}`;
                pnlEl.className = `text-sm mt-2 ${pnl >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;

                // 3. Positions
                const posRes = await fetch(`${API_BASE}/positions/active`);
                const positions = await posRes.json();

                document.getElementById('open-positions-count').innerText = positions.length;
                renderPositions(positions);

                // 4. Closed Positions
                const closedRes = await fetch(`${API_BASE}/positions/closed`);
                const closedPositions = await closedRes.json();
                renderClosedPositions(closedPositions);

                // Update win rate and realized PnL stats
                if (closedPositions.length > 0) {
                    const wins = closedPositions.filter(p => p.realizedPnL > 0).length;
                    const winRate = ((wins / closedPositions.length) * 100).toFixed(1);
                    const totalRealizedPnL = closedPositions.reduce((sum, p) => sum + p.realizedPnL, 0);

                    document.getElementById('win-rate').innerText = `Win Rate: ${winRate}%`;
                    const realizedEl = document.getElementById('total-realized-pnl');
                    realizedEl.innerText = `Realized: ${totalRealizedPnL >= 0 ? '+' : ''}${formatCurrency(totalRealizedPnL)}`;
                    realizedEl.className = `text-sm ${totalRealizedPnL >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
                }

            } catch (err) {
                console.error('Fetch error:', err);
                document.getElementById('status-text').innerText = 'OFFLINE';
                document.getElementById('status-text').className = 'text-rose-500 font-bold font-mono';
                // Show error details in cycle count for debugging
                document.getElementById('cycle-count').innerText = `Err: ${err.message}`;
            }
        }

        function renderPositions(positions) {
            const tbody = document.getElementById('positions-table');
            if (positions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-600 italic">No active positions... yet.</td></tr>`;
                return;
            }

            tbody.innerHTML = positions.map(p => `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="p-4 font-medium text-white truncate max-w-xs" title="${p.marketTitle}">${p.marketTitle}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${p.side === 'yes' ? 'bg-emerald-500/20 text-emerald-300' : 'bg-rose-500/20 text-rose-300'}">${p.side.toUpperCase()}</span></td>
                    <td class="p-4">${formatPrice(p.entryPrice)}</td>
                    <td class="p-4 text-white">${formatPrice(p.currentPrice)}</td>
                    <td class="p-4">${p.shares}</td>
                    <td class="p-4 font-mono font-bold ${p.pnlPercent >= 0 ? 'text-emerald-400' : 'text-rose-400'}">
                        ${p.pnlPercent >= 0 ? '+' : ''}${p.pnlPercent.toFixed(2)}%
                    </td>
                </tr>
            `).join('');
        }

        function renderClosedPositions(positions) {
            const tbody = document.getElementById('closed-positions-table');
            if (positions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="p-8 text-center text-slate-600 italic">No closed trades yet.</td></tr>`;
                return;
            }

            tbody.innerHTML = positions.map(p => `
                <tr class="hover:bg-white/5 transition-colors ${p.realizedPnL >= 0 ? 'border-l-2 border-emerald-500/50' : 'border-l-2 border-rose-500/50'}">
                    <td class="p-4 font-medium text-white truncate max-w-xs" title="${p.marketQuestion}">${p.marketQuestion.substring(0, 40)}...</td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${p.side === 'yes' ? 'bg-emerald-500/20 text-emerald-300' : 'bg-rose-500/20 text-rose-300'}">${p.side.toUpperCase()}</span></td>
                    <td class="p-4">${formatPrice(p.entryPrice)}</td>
                    <td class="p-4">${formatPrice(p.exitPrice)}</td>
                    <td class="p-4">${p.shares}</td>
                    <td class="p-4 font-mono font-bold ${p.realizedPnL >= 0 ? 'text-emerald-400' : 'text-rose-400'}">
                        ${p.realizedPnL >= 0 ? '+' : ''}${formatCurrency(p.realizedPnL)}
                    </td>
                    <td class="p-4 font-mono font-bold ${p.pnlPercent >= 0 ? 'text-emerald-400' : 'text-rose-400'}">
                        ${p.pnlPercent >= 0 ? '+' : ''}${p.pnlPercent.toFixed(2)}%
                    </td>
                    <td class="p-4 text-slate-500">${formatDuration(p.holdDurationSeconds)}</td>
                </tr>
            `).join('');
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
        }

        function formatPrice(num) {
            return '$' + num.toFixed(3); // Polymarket cents
        }

        function formatDuration(seconds) {
            const secs = Math.floor(seconds);
            if (secs < 60) return `${secs}s`;
            if (secs < 3600) return `${Math.floor(secs / 60)}m ${secs % 60}s`;
            const hrs = Math.floor(secs / 3600);
            const mins = Math.floor((secs % 3600) / 60);
            return `${hrs}h ${mins}m`;
        }

        function formatTime(seconds) {
            const secs = Math.floor(seconds);
            if (secs < 60) return secs + 's';
            const mins = Math.floor(secs / 60);
            const hrs = Math.floor(mins / 60);
            if (hrs > 0) return `${hrs}h ${mins % 60}m`;
            return `${mins}m ${secs % 60}s`;
        }

        // Poll every 3 seconds
        fetchStats();
        fetchSettings();
        setInterval(fetchStats, 3000);

        async function fetchSettings() {
            try {
                const res = await fetch(`${API_BASE}/settings`);
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('tp-input').value = data.takeProfit;
                    document.getElementById('sl-input').value = data.stopLoss;
                    document.getElementById('skip-price-check').checked = data.skipPriceCheck || false;
                    document.getElementById('poll-interval-input').value = data.pollIntervalMs || 5000;
                    document.getElementById('cache-ttl-input').value = data.cacheTtlMs || 2000;
                }
            } catch (err) {
                console.error('Failed to fetch settings:', err);
            }
        }

        async function saveSettings() {
            const tpInput = document.getElementById('tp-input');
            const slInput = document.getElementById('sl-input');
            const skipPriceCheckInput = document.getElementById('skip-price-check');
            const msgEl = document.getElementById('save-msg');

            const takeProfit = parseFloat(tpInput.value);
            const stopLoss = parseFloat(slInput.value);
            const skipPriceCheck = skipPriceCheckInput.checked;

            try {
                const res = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ takeProfit, stopLoss, skipPriceCheck })
                });

                if (res.ok) {
                    msgEl.innerText = '✅ Settings Saved!';
                    msgEl.className = 'text-sm text-emerald-400 opacity-100 transition-opacity';
                } else {
                    const data = await res.json();
                    msgEl.innerText = '❌ Error: ' + (data.error || 'Failed');
                    msgEl.className = 'text-sm text-rose-400 opacity-100 transition-opacity';
                }

                setTimeout(() => {
                    msgEl.className = 'text-sm opacity-0 transition-opacity';
                }, 3000);

            } catch (err) {
                console.error('Save error:', err);
                msgEl.innerText = '❌ Network Error';
                msgEl.className = 'text-sm text-rose-400 opacity-100 transition-opacity';
            }
        }

        async function saveSpeedSettings() {
            const pollIntervalInput = document.getElementById('poll-interval-input');
            const cacheTtlInput = document.getElementById('cache-ttl-input');
            const msgEl = document.getElementById('speed-save-msg');

            const intervalMs = parseInt(pollIntervalInput.value);
            const ttlMs = parseInt(cacheTtlInput.value);

            try {
                // Update poll interval
                const pollRes = await fetch(`${API_BASE}/settings/poll-interval`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ intervalMs })
                });

                // Update cache TTL
                const cacheRes = await fetch(`${API_BASE}/settings/cache-ttl`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ttlMs })
                });

                if (pollRes.ok && cacheRes.ok) {
                    msgEl.innerText = '✅ Speed Settings Saved!';
                    msgEl.className = 'text-sm text-emerald-400 opacity-100 transition-opacity';
                } else {
                    const pollData = await pollRes.json().catch(() => ({}));
                    const cacheData = await cacheRes.json().catch(() => ({}));
                    msgEl.innerText = '❌ Error: ' + (pollData.message || cacheData.message || 'Failed');
                    msgEl.className = 'text-sm text-rose-400 opacity-100 transition-opacity';
                }

                setTimeout(() => {
                    msgEl.className = 'text-sm opacity-0 transition-opacity';
                }, 3000);

            } catch (err) {
                console.error('Save speed settings error:', err);
                msgEl.innerText = '❌ Network Error';
                msgEl.className = 'text-sm text-rose-400 opacity-100 transition-opacity';
            }
        }
    </script>
</body>

</html>