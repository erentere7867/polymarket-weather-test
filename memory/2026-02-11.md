# Memory: 2026-02-11

## Polymarket Weather Trading Bot - Profitability Fixes

**Context:** User (Berfin via Telegram) reported that their weather arbitrage bot was losing ROI after recent updates. The bot was designed for speed arbitrage on weather prediction markets but was underperforming.

**Project Location:** `~/polymarket-weather-test`

### Issues Identified

1. **Threshold-Crossing Filter (Critical)** - `SPEED_ARB_REQUIRE_THRESHOLD_CROSSING=true` was blocking ~60% of valid signals. Bot only traded when forecast crossed a market threshold, ignoring valid edge opportunities.

2. **Sigma Filter Too High** - `MIN_SIGMA_FOR_ARBITRAGE = 0.5` filtered out marginal edge opportunities.

3. **Edge Decay Too Aggressive** - 1-minute half-life meant edge decayed 50% before execution due to S3 polling + parsing latency.

4. **Liquidity Filters Too Strict** - `$1000` min depth and `3%` max spread excluded thin weather markets.

5. **Take Profit Too Tight** - 5% TP didn't cover costs (spread + slippage + decay + fees = ~3-5%).

6. **Edge Threshold Too High** - `MIN_EDGE_THRESHOLD=0.10` (10%) missed 6-9% edge opportunities.

### Fixes Applied

**New config file created:** `.env.optimized` with key changes:
- `MIN_EDGE_THRESHOLD=0.06` (was 0.10)
- `SPEED_ARB_REQUIRE_THRESHOLD_CROSSING=false` (was true)
- `MIN_SIGMA_FOR_ARBITRAGE=0.3` (was 0.5)
- `EDGE_DECAY_HALF_LIFE_MS=90000` (was 60000)
- `MIN_ORDER_BOOK_DEPTH_USD=500` (was 1000)
- `MAX_BID_ASK_SPREAD=0.05` (was 0.03)
- `TAKE_PROFIT_THRESHOLD=0.08` (was 0.05/0.16)
- `MAX_POSITION_SIZE=50` (was 1000 - way too high for weather markets)

**Code changes made:**
- `src/strategy/speed-arbitrage.ts`: Sigma 0.5 → 0.3
- `src/simulation/portfolio.ts`: TP 5% → 8%
- `src/config.ts`: Unified exit thresholds

**Documentation created:** `PROFITABILITY_FIXES.md` with full breakdown and test plan.

### Key Insight

Speed arbitrage is a **volume game**, not a home run game. The bot was over-optimized for "perfect" 10%+ trades and missed the frequency needed to overcome fixed costs (~3-5% per trade). Lowering thresholds to capture 6-8% edge with higher volume should improve PnL.

### Next Steps for User

```bash
cd ~/polymarket-weather-test
cp .env .env.backup
cp .env.optimized .env
npm run simulate -- 100
```

### Expected Impact

- Trade frequency: 2-3/day → 5-10/day
- Win rate: <45% → 50-55%
- Net edge per trade: 5-7%
- PnL: Negative → Positive

---

## Berfin's Bot Architecture

**Strategies:**
- Speed Arbitrage (fast forecast change detection)
- Cross-Market Arbitrage (correlated city pairs)
- Kelly-based position sizing
- Market impact modeling

**Data Sources:**
- NOAA NWS (S3 file-based ingestion for sub-5s latency)
- OpenWeatherMap
- Open-Meteo
- Tomorrow.io webhooks

**Key Components:**
- `src/strategy/speed-arbitrage.ts` - Threshold-crossing detection with RAP-HRRR confirmation
- `src/strategy/entry-optimizer.ts` - Kelly criterion sizing, liquidity filtering
- `src/strategy/exit-optimizer.ts` - Trailing stops, regime-based exits
- `src/simulation/portfolio.ts` - PnL tracking, exposure management
