# Memory: 2026-02-12 - Weather Bot Profitability Overhaul

## Context
Major optimization session for Berfin's Polymarket weather trading bot. Goal: Improve win rate from ~50% to 65%+.

## Completed Work

### 1. Initial Analysis (by Claw)
Identified 6 critical issues:
- Threshold-crossing filter blocking 60% of signals
- Sigma filter too high (0.5 vs optimal 0.3)
- Edge decay too aggressive (1min half-life)
- Liquidity filters too strict for weather markets
- Take profit too tight (5% vs needed 8%+)
- Edge threshold too high (10% vs optimal 6%)

Applied initial fixes directly to .env and committed.

### 2. Subagent Analysis (4 agents with kimi-2.5)
Spawned specialized agents to analyze:
- Trading logic and edge calculation
- Weather model hierarchy and bias
- Exit strategy optimization
- Forecast-based exit logic

### 3. Critical Fixes Implemented (via subagents)

#### Exit Strategy (fix-exit-strategy)
- R:R ratio: 0.8:1 → 2:1 (8% TP/10% SL → 12% TP/6% SL)
- Trailing stop: Fixed to activate at 5%, trail 2.5%
- Added forecast-based exits (exit if forecast moves 5%+ against position)
- Added edge decay exits

#### Probability/Edge (fix-probability-edge)
- Fixed confidenceToProbability() with dynamic sigma by horizon
- Removed broken confidence formula in edge-calculator.ts
- Now uses actual stability-based confidence

#### Model Hierarchy (fix-model-hierarchy)
- Fixed Toronto/Vancouver: GFS primary (HRRR doesn't cover them)
- Added horizon-based model selection
- Tightened stability: 3 runs required, 0.2°C threshold
- Rebalanced confidence weights: 60% stability, 30% hierarchy, 10% regime

#### Forecast Exits (fix-forecast-exits)
- Added late trade detection (price velocity checks)
- Added freshness checks (no trades on >30min old forecasts)
- Added edge decay protection

### 4. Configuration Changes
- Default model switched from opus-4.6 to GLM-5
- Kimi k2.5 as fallback
- All subagents now use GLM-5 by default

## Files Modified
- .env (optimized parameters)
- src/config.ts (EXIT_CONFIG thresholds)
- src/strategy/exit-optimizer.ts (trailing stops, forecast exits)
- src/strategy/confidence-compression-strategy.ts (probability calculation)
- src/probability/edge-calculator.ts (confidence handling)
- src/strategy/model-hierarchy.ts (horizon-based selection)
- src/weather/types.ts (city-model mappings)
- src/strategy/run-stability-analyzer.ts (tighter thresholds)
- src/strategy/confidence-scorer.ts (rebalanced weights)
- src/strategy/entry-optimizer.ts (late trade detection)
- src/web/public/dashboard.js (filtered clutter)

## Expected Impact
- Win rate: ~50% → ~65%+
- R:R ratio: 0.8:1 → 2:1
- Trade quality: Higher (fewer false signals)
- Profit consistency: Improved

## Dashboard Improvements
- Filtered out stability-check-failed clutter
- Removed invalid price markets ($0)
- Shows only actionable trades with meaningful edge

## Notes for Future
- Bot is running with all fixes as of 2026-02-12 11:20 UTC
- Monitor win/loss ratio in dashboard
- Kelly heat increased to 0.50 to allow more concurrent trades
- All 4 subagent analyses saved in workspace/WEATHER_TRADING_ANALYSIS.md
